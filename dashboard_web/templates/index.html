<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Code Dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --border: #30363d;
    --text: #c9d1d9;
    --text-dim: #8b949e;
    --green: #3fb950;
    --yellow: #d29922;
    --red: #f85149;
    --blue: #58a6ff;
    --cyan: #39d353;
    --magenta: #bc8cff;
    --orange: #d18616;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 13px;
    line-height: 1.5;
    padding: 12px;
  }

  .header {
    text-align: center;
    padding: 10px 0 14px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 12px;
  }
  .header h1 {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--blue);
  }
  .header .meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  /* Top-level 3 numbers (Lenny) */
  .kpi-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
  }
  .kpi {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    text-align: center;
  }
  .kpi .value {
    font-size: 28px;
    font-weight: 700;
  }
  .kpi .label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 2px;
  }

  /* Next Action banner */
  .next-action {
    background: var(--card);
    border: 2px solid var(--green);
    border-radius: 8px;
    padding: 12px 20px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .next-action .arrow { font-size: 18px; }
  .next-action .text { font-size: 15px; font-weight: 700; flex: 1; }
  .next-action.level-error { border-color: var(--red); }
  .next-action.level-warning { border-color: var(--yellow); }
  .next-action.level-info { border-color: var(--cyan); }
  .next-action.level-ok { border-color: var(--green); }

  /* Grid */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
  }

  /* Panels */
  .panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
  }
  .panel-header:hover { background: rgba(255,255,255,0.03); }
  .panel-header .title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .panel-header .right {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Status light (Don Norman signifier) */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .status-dot.green { background: var(--green); box-shadow: 0 0 4px var(--green); }
  .status-dot.yellow { background: var(--yellow); box-shadow: 0 0 4px var(--yellow); }
  .status-dot.red { background: var(--red); box-shadow: 0 0 4px var(--red); }
  .status-dot.gray { background: var(--text-dim); }

  .panel-body {
    padding: 12px 14px;
    max-height: 400px;
    overflow-y: auto;
  }
  .panel-body.collapsed { display: none; }

  /* Chevron toggle */
  .chevron {
    transition: transform 0.2s;
    color: var(--text-dim);
    font-size: 10px;
  }
  .chevron.collapsed { transform: rotate(-90deg); }

  /* Usage panel */
  .progress-bar {
    height: 20px;
    background: #21262d;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
  }
  .progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: #fff;
  }
  .progress-fill.green { background: var(--green); }
  .progress-fill.yellow { background: var(--yellow); }
  .progress-fill.red { background: var(--red); }
  .progress-fill.blue { background: var(--blue); }

  .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    font-size: 12px;
  }
  .stat-row .label { color: var(--text-dim); }
  .stat-row .value { font-weight: 600; }

  .model-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
  }
  .model-badge.opus { background: rgba(63,185,80,0.2); color: var(--green); }
  .model-badge.sonnet { background: rgba(210,153,34,0.2); color: var(--yellow); }
  .model-badge.wind_down { background: rgba(248,81,73,0.2); color: var(--red); }

  /* Task list */
  .task-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
    border-bottom: 1px solid rgba(48,54,61,0.5);
  }
  .task-item:last-child { border-bottom: none; }
  .task-badge {
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 3px;
    min-width: 52px;
    text-align: center;
  }
  .task-badge.BLOCKED { background: rgba(248,81,73,0.2); color: var(--red); }
  .task-badge.IN-PROG { background: rgba(210,153,34,0.2); color: var(--yellow); }
  .task-badge.NEXT { background: rgba(139,148,158,0.15); color: var(--text-dim); }
  .task-badge.DONE { background: rgba(63,185,80,0.2); color: var(--green); }

  /* KB grid layout — columns with expandable folders */
  .kb-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 10px;
  }
  .kb-folder {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .kb-folder-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid transparent;
  }
  .kb-folder-header:hover { background: rgba(255,255,255,0.03); }
  .kb-folder-header.open { border-bottom-color: var(--border); }
  .kb-folder-name {
    font-size: 11px;
    font-weight: 700;
    color: var(--magenta);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .kb-folder-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
  }
  .kb-folder-total {
    font-weight: 700;
    color: var(--cyan);
  }
  .kb-folder-chevron {
    color: var(--text-dim);
    font-size: 9px;
    transition: transform 0.2s;
  }
  .kb-folder-chevron.closed { transform: rotate(-90deg); }
  .kb-folder-body {
    padding: 6px 10px;
  }
  .kb-folder-body.hidden { display: none; }
  .kb-source {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 2px 0;
  }
  .kb-bar {
    height: 5px;
    background: var(--blue);
    border-radius: 3px;
    opacity: 0.5;
    min-width: 2px;
  }
  .kb-count {
    font-weight: 700;
    font-size: 11px;
    min-width: 40px;
    text-align: right;
    color: var(--cyan);
  }
  .kb-name {
    font-size: 11px;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-dim);
  }

  /* Services */
  .svc-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 3px 0;
    font-size: 12px;
  }

  /* Warning bar */
  .warnings {
    background: rgba(248,81,73,0.1);
    border: 1px solid var(--red);
    border-radius: 6px;
    padding: 8px 14px;
    margin-bottom: 12px;
    font-size: 12px;
    color: var(--red);
  }
  .warnings .warn-item { padding: 2px 0; }

  /* Footer */
  .footer {
    text-align: center;
    padding: 10px;
    margin-top: 12px;
    color: var(--text-dim);
    font-size: 11px;
    border-top: 1px solid var(--border);
  }

  /* Refresh button */
  .refresh-btn {
    background: rgba(88,166,255,0.15);
    border: 1px solid var(--blue);
    color: var(--blue);
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    font-family: inherit;
  }
  .refresh-btn:hover { background: rgba(88,166,255,0.25); }

  /* Dual-window layout */
  .dual-window {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 700px) {
    .dual-window { grid-template-columns: 1fr; }
  }
  .window-card {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
  }
  .window-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  .lifetime-bar {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  /* Empty state */
  .empty { color: var(--text-dim); font-style: italic; font-size: 12px; padding: 8px 0; }
</style>
</head>
<body>

<div class="header">
  <h1>CLAUDE CODE DASHBOARD</h1>
  <div class="meta">
    <span id="clock"></span>
    &nbsp;&middot;&nbsp;
    <span id="poll-status">Connecting...</span>
    &nbsp;&middot;&nbsp;
    <button class="refresh-btn" onclick="doRefresh()">Refresh Budget</button>
  </div>
</div>

<!-- Warnings -->
<div id="warnings" class="warnings" style="display:none"></div>

<!-- KPI row -->
<div class="kpi-row">
  <div class="kpi">
    <div class="value" id="kpi-budget" style="color:var(--green)">--</div>
    <div class="label">Budget Used</div>
  </div>
  <div class="kpi">
    <div class="value" id="kpi-kb" style="color:var(--cyan)">--</div>
    <div class="label">KB Articles</div>
  </div>
  <div class="kpi">
    <div class="value" id="kpi-blocked" style="color:var(--red)">--</div>
    <div class="label">Blocked Tasks</div>
  </div>
  <div class="kpi">
    <div class="value" id="kpi-co2" style="color:var(--green)">--</div>
    <div class="label" id="kpi-co2-label">CO2 (g)</div>
  </div>
</div>

<!-- Next Action -->
<div id="next-action" class="next-action level-info">
  <span class="arrow">&raquo;</span>
  <span class="text" id="next-action-text">Loading...</span>
</div>

<!-- Panel Grid -->
<div class="grid">

  <!-- Usage & Limits (Dual Window) -->
  <div class="panel" id="panel-usage" style="grid-column: span 2">
    <div class="panel-header" onclick="toggle('usage')">
      <span class="title" style="color:var(--cyan)">Usage &amp; Limits</span>
      <span class="right">
        <span id="usage-age"></span>
        <span class="status-dot" id="usage-dot"></span>
        <span class="chevron" id="chevron-usage">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-usage"></div>
  </div>

  <!-- Tasks -->
  <div class="panel" id="panel-tasks">
    <div class="panel-header" onclick="toggle('tasks')">
      <span class="title" style="color:var(--magenta)">Task Priorities</span>
      <span class="right">
        <span id="task-count"></span>
        <span class="status-dot" id="tasks-dot"></span>
        <span class="chevron" id="chevron-tasks">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-tasks"></div>
  </div>

  <!-- Budget State -->
  <div class="panel" id="panel-budget">
    <div class="panel-header" onclick="toggle('budget')">
      <span class="title" style="color:var(--blue)">Budget State</span>
      <span class="right">
        <span id="budget-age"></span>
        <span class="status-dot" id="budget-dot"></span>
        <span class="chevron" id="chevron-budget">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-budget"></div>
  </div>

  <!-- Delegation & Gemini Routing -->
  <div class="panel" id="panel-delegation" style="grid-column: span 2">
    <div class="panel-header" onclick="toggle('delegation')">
      <span class="title" style="color:var(--orange)">Delegation &amp; Routing</span>
      <span class="right">
        <span id="delegation-summary"></span>
        <span class="status-dot" id="delegation-dot"></span>
        <span class="chevron" id="chevron-delegation">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-delegation"></div>
  </div>

  <!-- Knowledge Base -->
  <div class="panel" id="panel-kb" style="grid-column: span 2">
    <div class="panel-header" onclick="toggle('kb')">
      <span class="title" style="color:var(--green)">Knowledge Base</span>
      <span class="right">
        <span id="kb-count-header"></span>
        <span class="status-dot" id="kb-dot"></span>
        <span class="chevron" id="chevron-kb">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-kb"></div>
  </div>

  <!-- Environmental Impact -->
  <div class="panel" id="panel-env">
    <div class="panel-header" onclick="toggle('env')">
      <span class="title" style="color:var(--green)">Environmental Impact</span>
      <span class="right">
        <span id="env-level"></span>
        <span class="status-dot" id="env-dot"></span>
        <span class="chevron" id="chevron-env">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-env"></div>
  </div>

  <!-- Background Jobs -->
  <div class="panel" id="panel-jobs">
    <div class="panel-header" onclick="toggle('jobs')">
      <span class="title" style="color:var(--yellow)">Background Jobs</span>
      <span class="right">
        <span id="jobs-count"></span>
        <span class="status-dot" id="jobs-dot"></span>
        <span class="chevron" id="chevron-jobs">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-jobs"></div>
  </div>

  <!-- System -->
  <div class="panel" id="panel-system" style="grid-column: span 2">
    <div class="panel-header" onclick="toggle('system')">
      <span class="title" style="color:var(--red)">System</span>
      <span class="right">
        <span class="status-dot" id="system-dot"></span>
        <span class="chevron" id="chevron-system">&#9660;</span>
      </span>
    </div>
    <div class="panel-body" id="body-system"></div>
  </div>

</div>

<div class="footer">
  <span id="footer-time"></span>
  &nbsp;&middot;&nbsp; Polling every 1s &nbsp;&middot;&nbsp; Ctrl+C server to stop
</div>

<script>
// === STATE ===
let collapsed = {};
let lastData = null;
let pollErrors = 0;

// === TOGGLE ===
function toggle(id) {
  collapsed[id] = !collapsed[id];
  const body = document.getElementById('body-' + id);
  const chev = document.getElementById('chevron-' + id);
  if (collapsed[id]) {
    body.classList.add('collapsed');
    chev.classList.add('collapsed');
  } else {
    body.classList.remove('collapsed');
    chev.classList.remove('collapsed');
  }
}

// === FORMAT ===
function fmt(n) {
  if (n == null) return '--';
  return n.toLocaleString();
}

function co2Equiv(g) {
  if (g < 1) return '< 1 Google search';
  if (g < 8) return '~' + Math.round(g / 0.3) + ' Google searches';
  if (g < 36) { const c = g / 12.4; return c < 1.5 ? '~1 phone charge' : '~' + Math.round(c) + ' phone charges'; }
  if (g < 200) { const h = g / 36; return h < 1.5 ? '~1 hr Netflix' : '~' + Math.round(h) + ' hrs Netflix'; }
  if (g < 2000) { const cups = g / 21; return '~' + Math.round(cups) + ' cups of coffee'; }
  const mi = g / 393; return mi < 1 ? '~' + mi.toFixed(1) + ' mi driving' : '~' + Math.round(mi) + ' mi driving';
}

function setDot(id, color) {
  const el = document.getElementById(id);
  if (el) {
    el.className = 'status-dot ' + color;
  }
}

// === RENDER ===
function render(d) {
  lastData = d;
  const now = new Date().toLocaleTimeString();

  // Clock
  document.getElementById('clock').textContent = new Date().toLocaleString();
  document.getElementById('footer-time').textContent = 'Last update: ' + now;
  document.getElementById('poll-status').textContent = 'Live';

  // Warnings
  const warnEl = document.getElementById('warnings');
  if (d.warnings && d.warnings.length > 0) {
    warnEl.style.display = 'block';
    warnEl.innerHTML = d.warnings.map(w => '<div class="warn-item">! ' + esc(w) + '</div>').join('');
  } else {
    warnEl.style.display = 'none';
  }

  // KPIs — use gap window percentage (more accurate than 5h estimate)
  const pct5h = d.usage ? d.usage.percentage : 0;
  const gapTok = d.usage && d.usage.since_last_gap ? d.usage.since_last_gap.tokens_used : 0;
  const budgetTok = d.usage ? d.usage.budget : 500000;
  const gapPct = budgetTok > 0 ? (gapTok / budgetTok * 100) : 0;
  const pct = gapPct; // gap is primary
  const kpiBudget = document.getElementById('kpi-budget');
  kpiBudget.textContent = Math.round(pct) + '%';
  kpiBudget.style.color = pct < 50 ? 'var(--green)' : pct < 80 ? 'var(--yellow)' : 'var(--red)';
  document.querySelector('#kpi-budget + .label').textContent = 'Budget (This Burst)';

  document.getElementById('kpi-kb').textContent = fmt(d.kb ? d.kb.total : 0);

  const blockedCount = d.tasks ? d.tasks.filter(t => t.status === 'BLOCKED').length : 0;
  const kpiBlocked = document.getElementById('kpi-blocked');
  kpiBlocked.textContent = blockedCount;
  kpiBlocked.style.color = blockedCount > 0 ? 'var(--red)' : 'var(--green)';

  // CO2 KPI
  const envData = d.environmental || {};
  const co2 = envData.co2_g || 0;
  const kpiCo2 = document.getElementById('kpi-co2');
  kpiCo2.textContent = co2 < 1000 ? Math.round(co2) + 'g' : (co2/1000).toFixed(1) + 'kg';
  kpiCo2.style.color = co2 < 500 ? 'var(--green)' : co2 < 2000 ? 'var(--yellow)' : 'var(--red)';

  // Next Action
  if (d.next_action) {
    document.getElementById('next-action-text').textContent = d.next_action.text;
    const na = document.getElementById('next-action');
    na.className = 'next-action level-' + d.next_action.level;
  }

  // === Usage Panel (Dual Window) ===
  const usage = d.usage || {};
  const ageMin = d.budget_age_minutes;
  const ageText = ageMin != null ? Math.round(ageMin) + 'm ago' : 'N/A';
  document.getElementById('usage-age').textContent = ageText;
  setDot('usage-dot', ageMin != null && ageMin < 5 ? 'green' : ageMin != null && ageMin < 30 ? 'yellow' : 'red');

  const barPct = Math.min(pct, 100);
  const gap = usage.since_last_gap || {};
  const lifetime = usage.lifetime || {};
  const modelRec = usage.model_recommendation || 'opus';
  const modelClass = modelRec === 'opus' ? 'opus' : modelRec === 'wind_down' ? 'wind_down' : 'sonnet';
  const modelLabel = modelRec === 'opus' ? 'Opus (full power)' : modelRec === 'wind_down' ? 'WIND DOWN' : 'Sonnet (save budget)';

  // Format gap start time
  let gapTimeText = 'N/A';
  if (gap.gap_started) {
    try { gapTimeText = new Date(gap.gap_started).toLocaleTimeString(); } catch(e) {}
  }

  // Estimate hours remaining
  let rateText = '';
  if (pct > 0 && pct < 100) {
    const hoursLeft = ((100 - pct) / pct) * 5;
    rateText = '<div class="stat-row"><span class="label">At this rate</span><span class="value">' + hoursLeft.toFixed(1) + 'h left</span></div>';
  } else if (pct >= 100) {
    rateText = '<div class="stat-row"><span class="label">Status</span><span class="value" style="color:var(--red)">Budget exhausted</span></div>';
  }

  // First session date
  let firstSessionText = 'Unknown';
  if (lifetime.first_session) {
    try { firstSessionText = new Date(lifetime.first_session).toLocaleDateString(); } catch(e) {}
  }

  let usageHtml = '<div class="dual-window">';

  // LEFT (PRIMARY): Since-last-gap window — tracks actual burst usage
  const gapBarPct = Math.min(gapPct, 100);
  usageHtml += '<div class="window-card" style="border-color:var(--cyan)">';
  usageHtml += '<div class="window-title" style="color:var(--cyan)">Current Burst (since ' + esc(gapTimeText) + ')</div>';
  usageHtml += '<div class="progress-bar"><div class="progress-fill ' + (gapPct < 50 ? 'green' : gapPct < 80 ? 'yellow' : 'red') + '" style="width:' + gapBarPct + '%">' + Math.round(gapPct) + '%</div></div>';
  usageHtml += '<div class="stat-row"><span class="label">Tokens</span><span class="value">' + fmt(gap.tokens_used) + ' / ' + fmt(usage.budget) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Messages</span><span class="value">' + fmt(gap.messages) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Carbon</span><span class="value">' + (gap.carbon_g || 0).toFixed(1) + 'g CO2</span></div>';
  usageHtml += '<div class="stat-row"><span class="label"></span><span class="value" style="color:var(--text-dim);font-size:11px">' + co2Equiv(gap.carbon_g || 0) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Energy</span><span class="value">' + (gap.wh || 0).toFixed(1) + ' Wh</span></div>';
  // Rate estimate based on gap window
  if (gapPct > 0 && gapPct < 100) {
    const gapHoursLeft = ((100 - gapPct) / gapPct) * 5;
    usageHtml += '<div class="stat-row"><span class="label">At this rate</span><span class="value">' + gapHoursLeft.toFixed(1) + 'h left</span></div>';
  }
  usageHtml += '</div>';

  // RIGHT (SECONDARY): 5-hour rolling window estimate
  const barPct5h = Math.min(pct5h, 100);
  usageHtml += '<div class="window-card" style="opacity:0.7">';
  usageHtml += '<div class="window-title" style="color:var(--text-dim)">Est. 5-Hour Window <span style="font-size:9px;font-weight:400">(client-side)</span></div>';
  usageHtml += '<div class="progress-bar"><div class="progress-fill ' + (pct5h < 50 ? 'green' : pct5h < 80 ? 'yellow' : 'red') + '" style="width:' + barPct5h + '%">' + Math.round(pct5h) + '%</div></div>';
  usageHtml += '<div class="stat-row"><span class="label">Tokens</span><span class="value">' + fmt(usage.tokens_used) + ' / ' + fmt(usage.budget) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Messages</span><span class="value">' + fmt(usage.messages) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Carbon</span><span class="value">' + (usage.window_carbon_g || 0).toFixed(1) + 'g CO2</span></div>';
  usageHtml += '<div class="stat-row"><span class="label"></span><span class="value" style="color:var(--text-dim);font-size:11px">' + co2Equiv(usage.window_carbon_g || 0) + '</span></div>';
  usageHtml += '<div style="margin-top:6px;font-size:10px;color:var(--text-dim)">This is a local estimate. Anthropic\'s actual window timing is unknown. May overcount after inactivity gaps.</div>';
  usageHtml += '</div>';

  usageHtml += '</div>'; // end dual-window

  // This Session stats
  const sess = d.current_session;
  if (sess) {
    usageHtml += '<div style="margin-top:10px;padding:8px 10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:6px">';
    usageHtml += '<div style="display:flex;justify-content:space-between;align-items:center">';
    usageHtml += '<span style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--blue)">This Session</span>';
    usageHtml += '<span style="font-size:11px;color:var(--text-dim)">ID: ' + esc(sess.session_id) + '</span>';
    usageHtml += '</div>';
    usageHtml += '<div style="display:flex;gap:20px;margin-top:4px">';
    usageHtml += '<div class="stat-row" style="flex:1"><span class="label">Tokens</span><span class="value">' + fmt(sess.tokens) + '</span></div>';
    usageHtml += '<div class="stat-row" style="flex:1"><span class="label">Messages</span><span class="value">' + fmt(sess.messages) + '</span></div>';
    usageHtml += '</div></div>';
  }

  // Lifetime bar
  usageHtml += '<div class="lifetime-bar">';
  usageHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
  usageHtml += '<span style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--orange)">Lifetime</span>';
  usageHtml += '<span style="font-size:11px;color:var(--text-dim)">' + fmt(lifetime.total_sessions) + ' sessions since ' + esc(firstSessionText) + '</span>';
  usageHtml += '</div>';
  usageHtml += '<div class="stat-row"><span class="label">Total Tokens</span><span class="value">' + fmt(lifetime.total_tokens) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Total Messages</span><span class="value">' + fmt(lifetime.total_messages) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Total Carbon</span><span class="value" style="color:var(--orange)">' + (lifetime.total_carbon_g || 0).toFixed(1) + 'g CO2e (' + ((lifetime.total_carbon_g || 0)/1000).toFixed(2) + ' kg)</span></div>';
  usageHtml += '<div class="stat-row"><span class="label"></span><span class="value" style="color:var(--text-dim);font-size:11px">' + co2Equiv(lifetime.total_carbon_g || 0) + '</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Total Energy</span><span class="value">' + (lifetime.total_wh || 0).toFixed(1) + ' Wh (' + ((lifetime.total_wh || 0)/1000).toFixed(3) + ' kWh)</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Model</span><span class="value"><span class="model-badge ' + modelClass + '">' + esc(modelLabel) + '</span></span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Weekly Opus</span><span class="value">' + fmt(usage.weekly_opus_tokens) + ' tok / ' + fmt(usage.weekly_opus_messages) + ' msg</span></div>';
  usageHtml += '<div class="stat-row"><span class="label">Weekly Sonnet</span><span class="value">' + fmt(usage.weekly_sonnet_tokens) + ' tok / ' + fmt(usage.weekly_sonnet_messages) + ' msg</span></div>';
  usageHtml += '</div>';

  document.getElementById('body-usage').innerHTML = usageHtml;

  // === Tasks Panel ===
  const tasks = d.tasks || [];
  document.getElementById('task-count').textContent = tasks.length + ' tasks';
  setDot('tasks-dot', blockedCount > 0 ? 'red' : tasks.some(t => t.status === 'IN PROG') ? 'yellow' : 'green');

  if (tasks.length === 0) {
    document.getElementById('body-tasks').innerHTML = '<div class="empty">No tasks found in ACTIVE-TASKS.md</div>';
  } else {
    document.getElementById('body-tasks').innerHTML = tasks.map(t =>
      '<div class="task-item">' +
      '<span class="task-badge ' + t.status.replace(' ', '-') + '">' + esc(t.status) + '</span>' +
      '<span>' + esc(t.name) + '</span>' +
      '</div>'
    ).join('');
  }

  // === KB Panel ===
  renderKB(d.kb);

  // === Budget State Panel ===
  const bs = d.budget_state || {};
  document.getElementById('budget-age').textContent = ageText;
  setDot('budget-dot', ageMin != null && ageMin < 5 ? 'green' : ageMin != null && ageMin < 30 ? 'yellow' : 'red');

  const alertLevel = bs.alert_level || 'ok';
  const alertColors = { ok: 'var(--green)', info: 'var(--cyan)', warning: 'var(--yellow)', critical: 'var(--red)', limit: 'var(--red)' };
  const alertLabels = { ok: 'Budget Healthy', info: 'Above 50%', warning: 'Switch to Sonnet', critical: 'Sonnet Only', limit: 'Wind Down Now' };

  document.getElementById('body-budget').innerHTML =
    '<div class="stat-row"><span class="label">Data Age</span><span class="value">' + ageText + '</span></div>' +
    '<div class="stat-row"><span class="label">Alert</span><span class="value" style="color:' + (alertColors[alertLevel] || 'var(--text)') + '">' + (alertLabels[alertLevel] || alertLevel).toUpperCase() + '</span></div>' +
    '<div class="stat-row"><span class="label">Generated</span><span class="value" style="color:var(--text-dim)">' + esc(bs.generated || 'Unknown') + '</span></div>' +
    (d.environmental ? '<div class="stat-row"><span class="label">Lifetime Energy</span><span class="value">' + d.environmental.wh + ' Wh</span></div>' +
    '<div class="stat-row"><span class="label">Lifetime Carbon</span><span class="value">' + d.environmental.co2_g + 'g CO2e</span></div>' : '') +
    '<div style="margin-top:8px"><button class="refresh-btn" onclick="doRefresh()">Refresh Now</button></div>';

  // === Environmental Panel ===
  const env = d.environmental || {};
  const envLevel = env.level || 'Unknown';
  document.getElementById('env-level').textContent = envLevel;
  setDot('env-dot', env.color === 'green' ? 'green' : env.color === 'yellow' ? 'yellow' : env.color === 'red' ? 'red' : 'gray');

  const envColor = env.color === 'red' ? 'var(--red)' : env.color === 'yellow' ? 'var(--yellow)' : 'var(--green)';
  const uEnv = d.usage || {};
  const uGap = uEnv.since_last_gap || {};
  const uLife = uEnv.lifetime || {};

  let envHtml = '';
  envHtml += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;color:var(--cyan)">Per Window</div>';
  envHtml += '<div class="stat-row"><span class="label">5-Hour Window</span><span class="value">' + (uEnv.window_carbon_g || 0).toFixed(1) + 'g CO2 / ' + (uEnv.window_wh || 0).toFixed(1) + ' Wh</span></div>';
  envHtml += '<div class="stat-row"><span class="label">Since Last Gap</span><span class="value">' + (uGap.carbon_g || 0).toFixed(1) + 'g CO2 / ' + (uGap.wh || 0).toFixed(1) + ' Wh</span></div>';
  envHtml += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-top:10px;margin-bottom:6px;color:var(--orange)">Lifetime</div>';
  envHtml += '<div class="stat-row"><span class="label">Total Carbon</span><span class="value" style="color:' + envColor + '">' + (env.co2_g || 0).toLocaleString(undefined, {maximumFractionDigits:1}) + 'g CO2e</span></div>';
  envHtml += '<div class="stat-row"><span class="label">Total Energy</span><span class="value">' + (env.wh || 0).toLocaleString(undefined, {maximumFractionDigits:1}) + ' Wh</span></div>';
  envHtml += '<div class="stat-row"><span class="label">Impact Level</span><span class="value" style="color:' + envColor + '">' + esc(envLevel) + '</span></div>';
  if (env.equiv) {
    envHtml += '<div class="stat-row"><span class="label">Equivalent</span><span class="value" style="color:var(--text-dim)">' + esc(env.equiv) + '</span></div>';
  }
  envHtml += '<div style="margin-top:8px;font-size:10px;color:var(--text-dim)">Opus: 2.0 Wh/query | Grid: 379g CO2/kWh | PUE: 1.135</div>';
  document.getElementById('body-env').innerHTML = envHtml;

  // === Delegation Panel ===
  renderDelegation(d.delegation);

  // === Jobs Panel ===
  const jobs = d.jobs || { active: [], completed: [] };
  const activeJobs = jobs.active || [];
  document.getElementById('jobs-count').textContent = activeJobs.length + ' active';
  setDot('jobs-dot', activeJobs.length > 0 ? 'green' : 'gray');

  let jobsHtml = '<div style="margin-bottom:8px;font-weight:700;color:var(--yellow)">Active</div>';
  if (activeJobs.length > 0) {
    jobsHtml += activeJobs.map(j =>
      '<div class="svc-item"><span class="status-dot green"></span>' + esc(j.name) + ' <span style="color:var(--text-dim)">(PID ' + esc(j.pid) + ')</span></div>'
    ).join('');
  } else {
    jobsHtml += '<div class="empty">None running</div>';
  }

  const completed = jobs.completed || [];
  jobsHtml += '<div style="margin-top:10px;margin-bottom:4px;font-weight:700;color:var(--green)">Completed</div>';
  if (completed.length > 0) {
    const shown = completed.slice(0, 5);
    jobsHtml += shown.map(n => '<div style="font-size:12px;color:var(--text-dim);padding:2px 0">' + esc(n) + '</div>').join('');
    if (completed.length > 5) jobsHtml += '<div class="empty">+' + (completed.length - 5) + ' more</div>';
  } else {
    jobsHtml += '<div class="empty">None recorded</div>';
  }
  document.getElementById('body-jobs').innerHTML = jobsHtml;

  // === System Panel ===
  const sys = d.system || {};
  const errs = d.errors || { count: 0, recent: [] };
  const svcs = d.services || [];

  let diskPct = parseInt((sys.disk_pct || '0%').replace('%', ''));
  let diskColor = diskPct < 75 ? 'var(--green)' : diskPct < 90 ? 'var(--yellow)' : 'var(--red)';
  setDot('system-dot', errs.count > 0 ? 'red' : diskPct > 85 ? 'yellow' : 'green');

  let sysHtml = '<div style="font-weight:700;margin-bottom:6px">Disk</div>' +
    '<div class="stat-row"><span class="label">Claude temp</span><span class="value">' + esc(sys.claude_temp || 'N/A') + '</span></div>' +
    '<div class="stat-row"><span class="label">Disk free</span><span class="value">' + esc(sys.disk_free || 'N/A') + ' <span style="color:' + diskColor + '">(' + esc(sys.disk_pct || '?') + ')</span></span></div>';

  sysHtml += '<div style="font-weight:700;margin-top:10px;margin-bottom:6px">Services</div>';
  if (svcs.length > 0) {
    sysHtml += svcs.map(s => {
      const sc = s.status === 'Running' ? 'green' : s.status === 'Crashed' ? 'red' : 'yellow';
      return '<div class="svc-item"><span class="status-dot ' + sc + '"></span>' + esc(s.name) + '</div>';
    }).join('');
  } else {
    sysHtml += '<div class="empty">No services detected</div>';
  }

  sysHtml += '<div style="font-weight:700;margin-top:10px;margin-bottom:6px">Data Health</div>';
  if (errs.count === 0) {
    sysHtml += '<div style="color:var(--green)">All checks passing</div>';
  } else {
    sysHtml += '<div style="color:var(--red)">' + errs.count + ' issue(s) in 24h</div>';
    (errs.recent || []).forEach(e => {
      sysHtml += '<div style="color:var(--red);font-size:11px;opacity:0.7;padding:2px 0">! ' + esc((e.reason || '?').substring(0, 40)) + '</div>';
    });
  }
  document.getElementById('body-system').innerHTML = sysHtml;
}

// === DELEGATION RENDER ===
function renderDelegation(del_data) {
  if (!del_data) {
    document.getElementById('body-delegation').innerHTML = '<div class="empty">No delegation data yet</div>';
    setDot('delegation-dot', 'gray');
    return;
  }

  const calls = del_data.route_calls || 0;
  const success = del_data.route_success || 0;
  const pct = del_data.route_success_pct || 0;
  const saved = del_data.est_tokens_saved || 0;
  const gemToday = del_data.gemini_today || 0;
  const gemCap = del_data.gemini_cap || 250;
  const disabled = del_data.disabled_templates || [];
  const warned = del_data.warned_templates || [];

  // Summary in header
  document.getElementById('delegation-summary').textContent = calls + ' routes, ' + gemToday + '/' + gemCap + ' API';
  setDot('delegation-dot', disabled.length > 0 ? 'red' : pct >= 70 ? 'green' : pct >= 50 ? 'yellow' : calls === 0 ? 'gray' : 'red');

  let html = '';

  // Gemini API usage bar
  const gemPct = Math.min(gemToday / gemCap * 100, 100);
  const gemColor = gemPct < 50 ? 'green' : gemPct < 80 ? 'yellow' : 'red';
  html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;color:var(--orange)">Gemini Flash API</div>';
  html += '<div class="progress-bar"><div class="progress-fill ' + gemColor + '" style="width:' + gemPct + '%">' + gemToday + '/' + gemCap + '</div></div>';
  if (del_data.gemini_date) {
    html += '<div style="font-size:10px;color:var(--text-dim);margin-bottom:8px">Date: ' + esc(del_data.gemini_date) + '</div>';
  }

  // Token Savings Breakdown (session / today / all-time)
  const sessSaved = del_data.session_tokens_saved || 0;
  const todaySaved = del_data.today_tokens_saved || 0;
  const sessEff = del_data.session_efficiency_pct || 0;
  const todayEff = del_data.today_efficiency_pct || 0;
  const alltimeEff = del_data.alltime_efficiency_pct || 0;
  const sessClaude = del_data.session_claude_tokens || 0;

  html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-top:8px;margin-bottom:6px;color:var(--cyan)">Tokens Saved</div>';

  // Three-column: Session | Today | All-Time
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px">';

  html += '<div style="background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center">';
  html += '<div style="font-size:18px;font-weight:700;color:var(--green)">' + fmt(sessSaved) + '</div>';
  html += '<div style="font-size:10px;color:var(--text-dim);text-transform:uppercase">This Session</div>';
  html += '</div>';

  html += '<div style="background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center">';
  html += '<div style="font-size:18px;font-weight:700;color:var(--green)">' + fmt(todaySaved) + '</div>';
  html += '<div style="font-size:10px;color:var(--text-dim);text-transform:uppercase">Today</div>';
  html += '</div>';

  html += '<div style="background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center">';
  html += '<div style="font-size:18px;font-weight:700;color:var(--green)">' + fmt(saved) + '</div>';
  html += '<div style="font-size:10px;color:var(--text-dim);text-transform:uppercase">All-Time</div>';
  html += '</div>';

  html += '</div>';

  // Delegation Efficiency — what % of total work is offloaded
  html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;color:var(--cyan)">Delegation Efficiency</div>';
  html += '<div style="font-size:10px;color:var(--text-dim);margin-bottom:6px">tokens saved / (Claude tokens + saved)</div>';

  const effColor = (p) => p >= 5 ? 'var(--green)' : p >= 2 ? 'var(--yellow)' : 'var(--text-dim)';
  html += '<div class="stat-row"><span class="label">This Session</span><span class="value" style="color:' + effColor(sessEff) + '">' + sessEff + '% <span style="font-size:10px;color:var(--text-dim)">(' + fmt(sessSaved) + ' / ' + fmt(sessClaude + sessSaved) + ')</span></span></div>';
  html += '<div class="stat-row"><span class="label">Today</span><span class="value" style="color:' + effColor(todayEff) + '">' + todayEff + '%</span></div>';
  html += '<div class="stat-row"><span class="label">All-Time</span><span class="value" style="color:' + effColor(alltimeEff) + '">' + alltimeEff + '%</span></div>';

  // Daily history sparkline
  const byDate = del_data.by_date || [];
  if (byDate.length > 0) {
    html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-top:8px;margin-bottom:4px;color:var(--text-dim)">Daily History</div>';
    const maxDay = Math.max(...byDate.map(d => d.tokens_saved), 1);
    byDate.forEach(d => {
      const barW = Math.max(2, Math.round((d.tokens_saved / maxDay) * 80));
      html += '<div style="display:flex;align-items:center;gap:6px;padding:1px 0">';
      html += '<span style="min-width:65px;font-size:10px;color:var(--text-dim)">' + esc(d.date) + '</span>';
      html += '<span style="min-width:45px;text-align:right;font-size:11px;font-weight:700;color:var(--green)">' + fmt(d.tokens_saved) + '</span>';
      html += '<span style="height:5px;border-radius:3px;background:var(--green);opacity:0.5;width:' + barW + 'px"></span>';
      html += '<span style="font-size:10px;color:var(--text-dim)">' + d.calls + ' calls (' + d.success + ' ok)</span>';
      html += '</div>';
    });
  }

  // Template routing summary
  html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-top:10px;margin-bottom:6px;color:var(--text-dim)">Template Routing</div>';
  html += '<div class="stat-row"><span class="label">Total Calls</span><span class="value">' + fmt(calls) + '</span></div>';
  html += '<div class="stat-row"><span class="label">Success Rate</span><span class="value" style="color:' + (pct >= 70 ? 'var(--green)' : pct >= 50 ? 'var(--yellow)' : 'var(--red)') + '">' + pct + '%</span></div>';

  // Quality gate alerts
  if (disabled.length > 0) {
    html += '<div style="margin-top:8px;padding:6px 8px;background:rgba(248,81,73,0.1);border:1px solid var(--red);border-radius:4px">';
    html += '<div style="font-size:11px;font-weight:700;color:var(--red)">DISABLED (' + disabled.length + ')</div>';
    disabled.forEach(t => { html += '<div style="font-size:11px;color:var(--red);padding:1px 0">' + esc(t) + '</div>'; });
    html += '</div>';
  }
  if (warned.length > 0) {
    html += '<div style="margin-top:4px;padding:6px 8px;background:rgba(210,153,34,0.1);border:1px solid var(--yellow);border-radius:4px">';
    html += '<div style="font-size:11px;font-weight:700;color:var(--yellow)">WARNED (' + warned.length + ')</div>';
    warned.forEach(t => { html += '<div style="font-size:11px;color:var(--yellow);padding:1px 0">' + esc(t) + '</div>'; });
    html += '</div>';
  }

  // By category breakdown
  const cats = del_data.by_category || {};
  const catEntries = Object.entries(cats).sort((a, b) => b[1] - a[1]);
  if (catEntries.length > 0) {
    html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-top:10px;margin-bottom:4px;color:var(--text-dim)">By Category</div>';
    const maxCat = Math.max(...catEntries.map(e => e[1]), 1);
    catEntries.forEach(([cat, count]) => {
      const barW = Math.max(2, Math.round((count / maxCat) * 60));
      html += '<div style="display:flex;align-items:center;gap:6px;padding:1px 0">';
      html += '<span style="min-width:40px;text-align:right;font-size:11px;font-weight:700;color:var(--cyan)">' + count + '</span>';
      html += '<span class="kb-bar" style="width:' + barW + 'px;background:var(--orange)"></span>';
      html += '<span style="font-size:11px;color:var(--text-dim)">' + esc(cat) + '</span>';
      html += '</div>';
    });
  }

  // Model breakdown (Gemini, Ollama, Qwen, Groq)
  const byModel = del_data.by_model || {};
  const byExec = del_data.by_exec || {};
  const modelColors = { gemini: 'var(--blue)', ollama: 'var(--green)', qwen: 'var(--magenta)', groq: 'var(--orange)', claude: 'var(--cyan)', deepseek: 'var(--yellow)' };

  if (Object.keys(byModel).length > 0 || Object.keys(byExec).length > 0) {
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">';

    // Classifier picks
    html += '<div>';
    html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;color:var(--text-dim)">Router Picks</div>';
    const modelEntries = Object.entries(byModel).sort((a, b) => b[1] - a[1]);
    const maxModel = Math.max(...modelEntries.map(e => e[1]), 1);
    modelEntries.forEach(([m, count]) => {
      const barW = Math.max(2, Math.round((count / maxModel) * 50));
      const clr = modelColors[m] || 'var(--text-dim)';
      html += '<div style="display:flex;align-items:center;gap:4px;padding:1px 0">';
      html += '<span style="min-width:28px;text-align:right;font-size:11px;font-weight:700;color:' + clr + '">' + count + '</span>';
      html += '<span style="height:5px;border-radius:3px;background:' + clr + ';opacity:0.5;width:' + barW + 'px"></span>';
      html += '<span style="font-size:11px;color:var(--text-dim)">' + esc(m) + '</span>';
      html += '</div>';
    });
    html += '</div>';

    // Actual execution
    html += '<div>';
    html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;color:var(--text-dim)">Actual Execution</div>';
    const execEntries = Object.entries(byExec).sort((a, b) => b[1] - a[1]);
    const maxExec = Math.max(...execEntries.map(e => e[1]), 1);
    execEntries.forEach(([m, count]) => {
      const barW = Math.max(2, Math.round((count / maxExec) * 50));
      const clr = modelColors[m] || 'var(--text-dim)';
      html += '<div style="display:flex;align-items:center;gap:4px;padding:1px 0">';
      html += '<span style="min-width:28px;text-align:right;font-size:11px;font-weight:700;color:' + clr + '">' + count + '</span>';
      html += '<span style="height:5px;border-radius:3px;background:' + clr + ';opacity:0.5;width:' + barW + 'px"></span>';
      html += '<span style="font-size:11px;color:var(--text-dim)">' + esc(m) + '</span>';
      html += '</div>';
    });
    html += '</div>';

    html += '</div>';
  }

  // Hook stats
  if (del_data.hook_fires > 0) {
    html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-top:10px;margin-bottom:4px;color:var(--text-dim)">Hook Activity</div>';
    html += '<div class="stat-row"><span class="label">Hook Fires</span><span class="value">' + fmt(del_data.hook_fires) + '</span></div>';
    html += '<div class="stat-row"><span class="label">Pre-fetched</span><span class="value">' + fmt(del_data.prefetched) + '</span></div>';
    html += '<div class="stat-row"><span class="label">Avg Latency</span><span class="value">' + del_data.avg_latency_ms + 'ms</span></div>';
    if (del_data.delegation_rate && del_data.delegation_rate !== '0%') {
      html += '<div class="stat-row"><span class="label">Delegation Rate</span><span class="value">' + esc(del_data.delegation_rate) + '</span></div>';
    }
  }

  // Acceptance tracking
  if (del_data.acceptance && del_data.acceptance.total_delegated > 0) {
    var acc = del_data.acceptance;
    var rejPct = Math.round(acc.total_rejected * 100 / Math.max(acc.total_delegated, 1));
    var unkPct = Math.round(acc.total_unknown * 100 / Math.max(acc.total_delegated, 1));
    html += '<div style="font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-top:10px;margin-bottom:4px;color:var(--text-dim)">Acceptance</div>';
    html += '<div class="stat-row"><span class="label">Sessions</span><span class="value">' + fmt(acc.sessions_with_delegation) + '</span></div>';
    html += '<div class="stat-row"><span class="label">Total Delegated</span><span class="value">' + fmt(acc.total_delegated) + '</span></div>';
    html += '<div class="stat-row"><span class="label">Rejected</span><span class="value">' + fmt(acc.total_rejected) + ' (' + rejPct + '%)</span></div>';
    html += '<div class="stat-row"><span class="label">Unknown</span><span class="value">' + fmt(acc.total_unknown) + ' (' + unkPct + '%)</span></div>';
    var phase = del_data.acceptance_phase || 1;
    var phaseNames = {1: 'Core Signal', 2: 'Per-Template', 3: 'Self-Tuning'};
    html += '<div class="stat-row"><span class="label">Phase</span><span class="value">' + phase + ' (' + (phaseNames[phase] || '?') + ')</span></div>';
  }

  document.getElementById('body-delegation').innerHTML = html;
}

// Track which KB folders are open
let kbFolderState = {};

function toggleKBFolder(skill) {
  kbFolderState[skill] = !kbFolderState[skill];
  const body = document.getElementById('kb-body-' + skill);
  const chev = document.getElementById('kb-chev-' + skill);
  const hdr = document.getElementById('kb-hdr-' + skill);
  if (body) {
    if (kbFolderState[skill]) {
      body.classList.remove('hidden');
      chev.classList.remove('closed');
      hdr.classList.add('open');
    } else {
      body.classList.add('hidden');
      chev.classList.add('closed');
      hdr.classList.remove('open');
    }
  }
}

function renderKB(kb) {
  if (!kb) {
    document.getElementById('body-kb').innerHTML = '<div class="empty">No KB data</div>';
    return;
  }

  document.getElementById('kb-count-header').textContent = fmt(kb.total) + ' articles, ' + kb.source_count + ' sources';
  setDot('kb-dot', kb.source_count > 30 ? 'green' : kb.source_count > 10 ? 'yellow' : 'red');

  const bySkill = kb.by_skill || {};
  const maxCount = Math.max(...Object.values(kb.stats || {}).map(Number), 1);

  // Sort skills by total article count descending
  const sortedSkills = Object.entries(bySkill).sort((a, b) => b[1].total - a[1].total);

  let html = '<div class="kb-grid">';

  for (const [skill, data] of sortedSkills) {
    const isOpen = kbFolderState[skill] || false;
    const safeName = skill.replace(/[^a-z0-9-]/g, '_');
    const sources = (data.sources || []).sort((a, b) => b.count - a.count);
    const srcCount = sources.length;

    html += '<div class="kb-folder">';
    html += '<div class="kb-folder-header' + (isOpen ? ' open' : '') + '" id="kb-hdr-' + safeName + '" onclick="toggleKBFolder(\'' + safeName + '\')">';
    html += '<span class="kb-folder-name">' + esc(skill) + '</span>';
    html += '<span class="kb-folder-meta">';
    html += '<span class="kb-folder-total">' + fmt(data.total) + '</span>';
    html += '<span style="color:var(--text-dim);font-size:10px">' + srcCount + ' src</span>';
    html += '<span class="kb-folder-chevron' + (isOpen ? '' : ' closed') + '" id="kb-chev-' + safeName + '">&#9660;</span>';
    html += '</span></div>';

    html += '<div class="kb-folder-body' + (isOpen ? '' : ' hidden') + '" id="kb-body-' + safeName + '">';
    for (const src of sources) {
      const barW = Math.max(2, Math.round((src.count / maxCount) * 80));
      html += '<div class="kb-source">' +
        '<span class="kb-count">' + fmt(src.count) + '</span>' +
        '<span class="kb-bar" style="width:' + barW + 'px"></span>' +
        '<span class="kb-name">' + esc(src.name) + '</span>' +
        '</div>';
    }
    html += '</div></div>';
  }

  html += '</div>';
  document.getElementById('body-kb').innerHTML = html;

  // Re-apply folder state after re-render (preserve which are open)
  for (const [skill, isOpen] of Object.entries(kbFolderState)) {
    if (isOpen) {
      const body = document.getElementById('kb-body-' + skill);
      const chev = document.getElementById('kb-chev-' + skill);
      const hdr = document.getElementById('kb-hdr-' + skill);
      if (body) { body.classList.remove('hidden'); }
      if (chev) { chev.classList.remove('closed'); }
      if (hdr) { hdr.classList.add('open'); }
    }
  }
}

// === ESCAPE HTML ===
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

// === POLLING ===
async function poll() {
  try {
    const r = await fetch('/api/data');
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const d = await r.json();
    render(d);
    pollErrors = 0;
  } catch (e) {
    pollErrors++;
    document.getElementById('poll-status').textContent = 'Error (' + pollErrors + ')';
    if (pollErrors > 10) {
      document.getElementById('poll-status').textContent = 'Connection lost';
    }
  }
}

async function doRefresh() {
  try {
    await fetch('/api/refresh');
    // Give track_resources.py a moment to write
    setTimeout(poll, 2000);
  } catch (e) {
    // ignore
  }
}

// Start polling
poll();
setInterval(poll, 1000);
</script>

</body>
</html>
